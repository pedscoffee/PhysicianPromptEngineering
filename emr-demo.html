<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Documentation Module - DEMO</title>
    <style>
        /* ============================================
           EMR DEMO - STYLES
           Professional EMR-like interface for video demos
           ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* EMR Color Palette - Professional Blues/Grays */
            --emr-primary: #2c5f8d;
            --emr-primary-dark: #1a3d5f;
            --emr-primary-light: #4a7ba7;
            --emr-secondary: #5a7d9a;
            --emr-accent: #3b82a0;

            --emr-bg-main: #f0f4f8;
            --emr-bg-panel: #ffffff;
            --emr-bg-input: #fafbfc;
            --emr-bg-output: #f8fafb;
            --emr-bg-header: #1a3d5f;

            --emr-border: #d1dce5;
            --emr-border-dark: #a8b8c8;

            --emr-text-primary: #1e3a4f;
            --emr-text-secondary: #5a6c7d;
            --emr-text-light: #7a8a9a;

            --emr-success: #2d7a5c;
            --emr-warning: #c87d3a;
            --emr-danger: #b83b3b;
        }

        body {
            font-family: 'Segoe UI', 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
            background: var(--emr-bg-main);
            color: var(--emr-text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ============================================
           WATERMARK
           ============================================ */

        .demo-watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 120px;
            font-weight: bold;
            color: rgba(44, 95, 141, 0.03);
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
            user-select: none;
        }

        /* ============================================
           HEADER - EMR-like
           ============================================ */

        .emr-header {
            background: linear-gradient(135deg, var(--emr-bg-header) 0%, var(--emr-primary) 100%);
            color: white;
            padding: 16px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .emr-logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .emr-logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--emr-primary);
            font-size: 18px;
        }

        .emr-title {
            display: flex;
            flex-direction: column;
        }

        .emr-title h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.3px;
        }

        .emr-title .subtitle {
            font-size: 12px;
            opacity: 0.85;
            font-weight: 400;
        }

        .emr-header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 13px;
        }

        .emr-header-info .badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 500;
        }

        .demo-badge {
            background: var(--emr-warning) !important;
            color: white;
            font-weight: 600;
            padding: 6px 14px !important;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ============================================
           MAIN LAYOUT - Three Panel
           ============================================ */

        .emr-container {
            padding: 24px;
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .emr-workspace {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ============================================
           PANELS - EMR Form Style
           ============================================ */

        .emr-panel {
            background: var(--emr-bg-panel);
            border: 1px solid var(--emr-border);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(to bottom, #f8fafb 0%, #eef2f5 100%);
            border-bottom: 2px solid var(--emr-border);
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--emr-text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title-icon {
            width: 18px;
            height: 18px;
            color: var(--emr-primary);
        }

        .panel-timestamp {
            font-size: 11px;
            color: var(--emr-text-light);
            font-weight: 400;
        }

        .panel-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* ============================================
           FORM ELEMENTS - Clinical Style
           ============================================ */

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--emr-text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-label .required {
            color: var(--emr-danger);
        }

        .form-select {
            padding: 10px 12px;
            border: 1px solid var(--emr-border-dark);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: var(--emr-bg-input);
            color: var(--emr-text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-select:hover {
            border-color: var(--emr-primary);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--emr-primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
        }

        .clinical-textarea {
            flex: 1;
            padding: 14px;
            border: 1px solid var(--emr-border-dark);
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            background: var(--emr-bg-input);
            color: var(--emr-text-primary);
            transition: all 0.2s;
        }

        .clinical-textarea:focus {
            outline: none;
            border-color: var(--emr-primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
            background: white;
        }

        .clinical-textarea.output {
            background: var(--emr-bg-output);
            border-left: 3px solid var(--emr-success);
        }

        .clinical-textarea:disabled {
            background: #f5f7f9;
            color: var(--emr-text-secondary);
            cursor: not-allowed;
        }

        /* ============================================
           MIDDLE CONTROL PANEL
           ============================================ */

        .control-panel {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .transform-button {
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--emr-primary) 0%, var(--emr-primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(44, 95, 141, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .transform-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(44, 95, 141, 0.4);
        }

        .transform-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .transform-button:disabled {
            background: linear-gradient(135deg, #a8b8c8 0%, #8a9aa8 100%);
            cursor: not-allowed;
            box-shadow: none;
        }

        .transform-button .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           STATUS INDICATORS
           ============================================ */

        .status-bar {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid;
        }

        .status-bar.info {
            background: #e6f2ff;
            border-color: #99caff;
            color: #1a5490;
        }

        .status-bar.success {
            background: #e6f7f1;
            border-color: #7dd3b0;
            color: #1a5f44;
        }

        .status-bar.warning {
            background: #fff5e6;
            border-color: #ffd699;
            color: #8a5a1a;
        }

        .status-bar.error {
            background: #ffe6e6;
            border-color: #ff9999;
            color: #8a1a1a;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ============================================
           FOOTER ACTIONS
           ============================================ */

        .emr-footer {
            margin-top: 20px;
            padding: 20px;
            background: var(--emr-bg-panel);
            border: 1px solid var(--emr-border);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 18px;
            border: 1px solid var(--emr-border-dark);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary {
            background: white;
            color: var(--emr-text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--emr-bg-main);
            border-color: var(--emr-primary);
        }

        .btn-primary {
            background: var(--emr-primary);
            color: white;
            border-color: var(--emr-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--emr-primary-dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer-info {
            font-size: 12px;
            color: var(--emr-text-light);
        }

        /* ============================================
           AI ENGINE STATUS
           ============================================ */

        .ai-status-panel {
            background: var(--emr-bg-panel);
            border: 1px solid var(--emr-border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-status-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .ai-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .ai-status-dot.loading {
            background: var(--emr-warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .ai-status-dot.ready {
            background: var(--emr-success);
        }

        .ai-status-dot.error {
            background: var(--emr-danger);
        }

        .init-ai-btn {
            padding: 8px 16px;
            background: var(--emr-accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .init-ai-btn:hover:not(:disabled) {
            background: var(--emr-primary);
        }

        .init-ai-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */

        @media (max-width: 1400px) {
            .emr-workspace {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .control-panel {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }

            .control-panel .emr-panel {
                flex: 1;
                min-width: 280px;
            }
        }

        @media (max-width: 768px) {
            .emr-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .emr-container {
                padding: 16px;
            }

            .emr-footer {
                flex-direction: column;
                gap: 16px;
            }

            .footer-actions {
                width: 100%;
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--emr-text-light);
        }

        .mt-2 {
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Watermark -->
    <div class="demo-watermark">DEMO - FOR TRAINING ONLY</div>

    <!-- EMR Header -->
    <header class="emr-header">
        <div class="emr-logo-section">
            <div class="emr-logo">EMR</div>
            <div class="emr-title">
                <h1>Clinical Documentation Module</h1>
                <span class="subtitle">AI-Assisted Note Transformation</span>
            </div>
        </div>
        <div class="emr-header-info">
            <span class="badge demo-badge">üé• DEMO MODE</span>
            <span class="badge" id="current-date"></span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="emr-container">
        <!-- AI Engine Status -->
        <div class="ai-status-panel">
            <div class="ai-status-info">
                <div class="ai-status-dot" id="ai-status-dot"></div>
                <span id="ai-status-text">AI Engine: Not Loaded</span>
            </div>
            <button class="init-ai-btn" id="init-ai-btn">Initialize AI Engine</button>
        </div>

        <!-- Three Panel Workspace -->
        <div class="emr-workspace">
            <!-- LEFT PANEL: AI Scribe Output (Input) -->
            <div class="emr-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <svg class="panel-title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                        AI Scribe Output
                    </div>
                    <span class="panel-timestamp">Last Updated: <span id="input-timestamp">--</span></span>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label class="form-label" for="case-selector">
                            <span>Load Example Case</span>
                        </label>
                        <select class="form-select" id="case-selector">
                            <option value="">-- Select a pre-loaded case --</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                        <label class="form-label" for="scribe-input">
                            <span>Raw AI Transcription</span>
                            <span class="text-muted" style="font-weight: 400;">(Paste or type)</span>
                        </label>
                        <textarea
                            class="clinical-textarea"
                            id="scribe-input"
                            placeholder="Paste AI scribe transcription here...

Example: Patient is a 45-year-old male presenting with..."
                        ></textarea>
                    </div>
                </div>
            </div>

            <!-- MIDDLE PANEL: Transformation Controls -->
            <div class="control-panel">
                <div class="emr-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <svg class="panel-title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Transform Settings
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="form-label" for="prompt-selector">
                                <span>Clinical Prompt <span class="required">*</span></span>
                            </label>
                            <select class="form-select" id="prompt-selector">
                                <option value="">-- Select transformation prompt --</option>
                            </select>
                        </div>
                        <button class="transform-button" id="transform-btn" disabled>
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span id="transform-btn-text">Transform Note</span>
                        </button>
                        <div class="status-bar info" id="status-message">
                            <div class="status-indicator"></div>
                            <span>Select a prompt and enter scribe output to begin</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Polished Clinical Note (Output) -->
            <div class="emr-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <svg class="panel-title-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Polished Clinical Note
                    </div>
                    <span class="panel-timestamp">Generated: <span id="output-timestamp">--</span></span>
                </div>
                <div class="panel-body">
                    <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                        <label class="form-label" for="clinical-output">
                            <span>Transformed Output</span>
                            <span class="text-muted" style="font-weight: 400;">(AI-generated)</span>
                        </label>
                        <textarea
                            class="clinical-textarea output"
                            id="clinical-output"
                            placeholder="Transformed clinical note will appear here..."
                            disabled
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="emr-footer">
            <div class="footer-info">
                <strong>‚ö†Ô∏è Synthetic Data Only:</strong> This demo uses simulated patient data for training purposes only.
            </div>
            <div class="footer-actions">
                <button class="btn btn-secondary" id="clear-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Clear All
                </button>
                <button class="btn btn-secondary" id="copy-btn" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Copy Output
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        // =====================================================
        // PROMPT LIBRARY DATA
        // =====================================================

        const PROMPT_LIBRARY = {
            "ap-formatting-pithy": {
                title: "A/P Formatting ('Pithy')",
                description: "Transforms AI scribe paragraphs into scannable, problem-oriented notes",
                content: `Reformat the assessment and plan into a structured, problem-oriented format. The output should be extremely concise for rapid scanning.

---

## Output Structure for Each Problem/Diagnosis

**[Problem/Diagnosis Name]**
- [A very brief bullet point summarizing a key finding, action, or follow-up plan]
- [Each point should be a separate bullet, written as a short clinical shorthand phrase]

---

## Formatting Rules

1. Bold formatting for problem names
2. Do NOT use section headers like Assessment or Plan
3. Use a hyphen (-) for all bullets
4. Write all bullet points in extremely brief, professional shorthand phrases
5. Keep bullets concise (ideally under 10 words per bullet)
6. Use standard medical abbreviations (RTC, PRN, BID, etc.)
7. Never fabricate or infer information not present in the source text
8. Insert a blank line between problems when multiple diagnoses exist

---

## Few-Shot Examples

**Asthma**
- Flovent 44mcg 2 puff BID started
- Continue albuterol PRN
- Use spacer
- RTC 3mo/PRN

**Well Child Check**
- Growing and developing well
- Reviewed anticipatory guidance
- RTC 1yr/PRN

**Vomiting, mild dehydration**
- NDNT on exam with MMM
- Zofran PRN, pedialyte, Tylenol, Motrin
- RTC PRN

**Viral URI**
- Supportive care, fluids
- Declined COVID test
- RTC PRN`
            },
            "concise-sign-out": {
                title: "Concise Sign Out",
                description: "Creates brief, focused handoff notes for end-of-shift transitions",
                content: `Create a concise sign-out note for handoff. Focus on what the next provider needs to know.

---

## Output Format

**Patient: [Age/Sex/Brief ID]**
**Primary Issue:** [One-liner diagnosis/reason for visit]

**Key Updates:**
- [Most important recent developments]
- [Pending results or decisions]

**Overnight Tasks:**
- [Specific action items]
- [What to watch for]

**Contact:** [When to escalate]

---

## Example

**Patient: 68F with CHF exacerbation**
**Primary Issue:** Acute decompensated heart failure, improving on diuresis

**Key Updates:**
- Net negative 2L today, breathing better
- BNP down from 1200 to 800
- Cr stable at 1.2

**Overnight Tasks:**
- Continue Lasix 40mg IV q12h (next dose 0600)
- Monitor strict I/Os
- Recheck BMP in AM

**Contact:** Call if O2 sat <92% or UOP <30cc/hr`
            },
            "structured-soap": {
                title: "Structured SOAP Note",
                description: "Converts unstructured notes into standard SOAP format",
                content: `Convert the provided clinical information into a structured SOAP note format.

---

## Output Format

**SUBJECTIVE:**
[Patient's presenting complaint and history in paragraph form]

**OBJECTIVE:**
Vitals: [VS]
Physical Exam:
- [System-based findings]

Labs/Imaging: [If applicable]

**ASSESSMENT:**
[Diagnosis or clinical impression]

**PLAN:**
1. [Numbered plan items]
2. [Include medications, follow-up, patient education]

---

## Example

**SUBJECTIVE:**
45-year-old male with 3 days of right knee pain after playing tennis. Pain is sharp, 6/10, worse with walking. Tried ibuprofen with some relief. Denies swelling, redness, or fevers.

**OBJECTIVE:**
Vitals: BP 130/80, HR 72, Temp 98.6
Physical Exam:
- General: No acute distress
- MSK: Right knee with mild tenderness over medial joint line, ROM intact but painful at end flexion, no effusion

**ASSESSMENT:**
Right knee pain, likely medial meniscus strain

**PLAN:**
1. Rest, ice, compression, elevation
2. Continue NSAIDs PRN
3. Return if worse or no improvement in 1 week`
            }
        };

        // =====================================================
        // SYNTHETIC CASE DATA
        // =====================================================

        const SYNTHETIC_CASES = [
            {
                id: "case_simple_soap",
                name: "Outpatient SOAP (Paragraph)",
                content: `SUBJECTIVE:
Patient is a 45-year-old male presenting with 3 days of right knee pain. He states it started after playing tennis. The pain is sharp, 6/10, worse with walking, better with rest. No swelling or redness noted. He has tried Ibuprofen with some relief. Denies fevers or chills.

OBJECTIVE:
Vitals: BP 130/80, HR 72, Temp 98.6.
Gen: NAD.
MSK: Right knee with mild tenderness over medial joint line. McMurray's negative. Lachman's negative. ROM intact but painful at end flexion. No effusion.

ASSESSMENT:
Right knee pain, likely medial meniscus strain vs sprain.

PLAN:
1. Rest, Ice, Compression, Elevation.
2. Continue NSAIDs prn.
3. Return if worse or no improvement in 1 week.`
            },
            {
                id: "case_complex_admission",
                name: "Hospital Admission (Bulleted)",
                content: `HISTORY OF PRESENT ILLNESS:
Patient is a 68-year-old female with PMH of CHF, COPD, and Diabetes who presents with shortness of breath.

*   Onset: 2 days ago, gradual worsening.
*   Severity: Now dyspneic at rest.
*   Associated Sx: Orthopnea (3 pillows), PND, and increased leg swelling.
*   Triggers: None identified. No missed meds.
*   ROS: Positive for cough (dry), negative for fever, chest pain.

PHYSICAL EXAM:
Gen: Sitting upright, tachypneic.
Lungs: Crackles bilateral bases halfway up. Wheezing expiratory.
Heart: RRR, S3 gallop present. 2+ pitting edema to knees.

LABS/IMAGING:
Na 135, K 4.5, Cr 1.2 (baseline 1.0).
BNP: 1200.
CXR: Pulmonary edema, cardiomegaly.

ASSESSMENT/PLAN:
1. Acute Decompensated Heart Failure
   - Likely due to dietary indiscretion.
   - Start Lasix 40mg IV BID.
   - Monitor I/Os, daily weights.
2. COPD Exacerbation
   - Mild wheezing, likely reactive.
   - Cont Duonebs.
3. Diabetes Type 2
   - SSI.`
            },
            {
                id: "case_rough_dictation",
                name: "Voice Dictation (Unstructured)",
                content: `Patient is here for follow up of hypertension. Uh, blood pressure today was 150 over 90. He says he missed a few doses of his lisinopril because he ran out. No chest pain or shortness of breath. Exam is normal heart sounds regular lungs clear. I'm gonna refill his lisinopril 20 milligrams daily and told him to take it every day. Also checked a chem 7 which was normal. Potassium 4.2. Creatinine 0.9. Follow up in 3 months.`
            }
        ];

        // =====================================================
        // STATE MANAGEMENT
        // =====================================================

        class EMRDemo {
            constructor() {
                this.llm = null;
                this.isInitialized = false;

                // UI Elements
                this.scribeInput = document.getElementById('scribe-input');
                this.clinicalOutput = document.getElementById('clinical-output');
                this.caseSelector = document.getElementById('case-selector');
                this.promptSelector = document.getElementById('prompt-selector');
                this.transformBtn = document.getElementById('transform-btn');
                this.transformBtnText = document.getElementById('transform-btn-text');
                this.copyBtn = document.getElementById('copy-btn');
                this.clearBtn = document.getElementById('clear-btn');
                this.initAIBtn = document.getElementById('init-ai-btn');
                this.aiStatusDot = document.getElementById('ai-status-dot');
                this.aiStatusText = document.getElementById('ai-status-text');
                this.statusMessage = document.getElementById('status-message');
                this.inputTimestamp = document.getElementById('input-timestamp');
                this.outputTimestamp = document.getElementById('output-timestamp');

                this.init();
            }

            init() {
                this.populateUI();
                this.bindEvents();
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 60000); // Update every minute
            }

            populateUI() {
                // Populate prompts
                Object.entries(PROMPT_LIBRARY).forEach(([key, prompt]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = prompt.title;
                    this.promptSelector.appendChild(option);
                });

                // Populate cases
                SYNTHETIC_CASES.forEach(case_ => {
                    const option = document.createElement('option');
                    option.value = case_.id;
                    option.textContent = case_.name;
                    this.caseSelector.appendChild(option);
                });
            }

            bindEvents() {
                this.caseSelector.addEventListener('change', () => this.loadCase());
                this.promptSelector.addEventListener('change', () => this.updateTransformButton());
                this.scribeInput.addEventListener('input', () => {
                    this.updateTransformButton();
                    this.updateInputTimestamp();
                });
                this.transformBtn.addEventListener('click', () => this.transformNote());
                this.copyBtn.addEventListener('click', () => this.copyOutput());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.initAIBtn.addEventListener('click', () => this.initializeAI());
            }

            loadCase() {
                const selectedId = this.caseSelector.value;
                if (!selectedId) {
                    this.scribeInput.value = '';
                    return;
                }

                const case_ = SYNTHETIC_CASES.find(c => c.id === selectedId);
                if (case_) {
                    this.scribeInput.value = case_.content;
                    this.updateInputTimestamp();
                    this.updateTransformButton();
                }
            }

            updateTransformButton() {
                const hasInput = this.scribeInput.value.trim().length > 0;
                const hasPrompt = this.promptSelector.value !== '';

                this.transformBtn.disabled = !(hasInput && hasPrompt && this.isInitialized);

                if (!hasInput || !hasPrompt) {
                    this.updateStatus('info', 'Select a prompt and enter scribe output to begin');
                } else if (!this.isInitialized) {
                    this.updateStatus('warning', 'Initialize AI Engine to transform notes');
                } else {
                    this.updateStatus('success', 'Ready to transform');
                }
            }

            updateStatus(type, message) {
                this.statusMessage.className = `status-bar ${type}`;
                this.statusMessage.querySelector('span').textContent = message;
            }

            updateInputTimestamp() {
                const now = new Date();
                this.inputTimestamp.textContent = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            updateOutputTimestamp() {
                const now = new Date();
                this.outputTimestamp.textContent = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            updateDateTime() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const timeStr = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('current-date').textContent = `${dateStr} ${timeStr}`;
            }

            async initializeAI() {
                if (this.isInitialized) return;

                try {
                    this.updateAIStatus('loading', 'Initializing AI (downloading ~2GB)...');
                    this.initAIBtn.disabled = true;
                    this.initAIBtn.textContent = 'Loading...';

                    if (!navigator.gpu) {
                        throw new Error('WebGPU not supported. Please use Chrome or Edge 113+');
                    }

                    // Check if shared LLM already exists
                    if (window.sharedLLM) {
                        this.llm = window.sharedLLM;
                        this.isInitialized = true;
                        this.updateAIStatus('ready', 'AI Engine: Ready');
                        this.initAIBtn.style.display = 'none';
                        this.updateTransformButton();
                        return;
                    }

                    const mlcModule = await import('https://esm.run/@mlc-ai/web-llm');
                    const CreateMLCEngine = mlcModule.CreateMLCEngine || mlcModule.default?.CreateMLCEngine;

                    this.llm = await CreateMLCEngine("Llama-3.2-1B-Instruct-q4f16_1-MLC", {
                        initProgressCallback: (progress) => {
                            const percent = Math.round(progress.progress * 100);
                            this.updateAIStatus('loading', `Loading AI: ${percent}%`);
                        }
                    });

                    this.isInitialized = true;
                    window.sharedLLM = this.llm;
                    this.updateAIStatus('ready', 'AI Engine: Ready');
                    this.initAIBtn.style.display = 'none';
                    this.updateTransformButton();

                } catch (error) {
                    console.error('AI initialization error:', error);
                    this.updateAIStatus('error', 'AI Engine: Error');
                    this.initAIBtn.disabled = false;
                    this.initAIBtn.textContent = 'Retry Initialization';
                    this.updateStatus('error', `Failed to load AI: ${error.message}`);
                }
            }

            updateAIStatus(status, text) {
                this.aiStatusDot.className = `ai-status-dot ${status}`;
                this.aiStatusText.textContent = text;
            }

            async transformNote() {
                if (!this.isInitialized) {
                    await this.initializeAI();
                    if (!this.isInitialized) return;
                }

                const input = this.scribeInput.value.trim();
                const promptKey = this.promptSelector.value;

                if (!input || !promptKey) return;

                const prompt = PROMPT_LIBRARY[promptKey];

                // Update UI to processing state
                this.transformBtn.disabled = true;
                this.transformBtnText.innerHTML = '<div class="spinner"></div> Processing...';
                this.updateStatus('info', 'AI is transforming your note...');
                this.clinicalOutput.value = 'Generating transformed note...';
                this.clinicalOutput.disabled = false;

                try {
                    const messages = [
                        { role: 'system', content: prompt.content },
                        { role: 'user', content: input }
                    ];

                    const response = await this.llm.chat.completions.create({
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2000
                    });

                    const output = response.choices[0].message.content;
                    this.clinicalOutput.value = output;
                    this.updateOutputTimestamp();
                    this.copyBtn.disabled = false;
                    this.updateStatus('success', 'Transformation complete!');

                } catch (error) {
                    console.error('Transformation error:', error);
                    this.clinicalOutput.value = `Error during transformation: ${error.message}`;
                    this.updateStatus('error', `Transformation failed: ${error.message}`);
                } finally {
                    this.transformBtn.disabled = false;
                    this.transformBtnText.innerHTML = `
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Transform Note
                    `;
                }
            }

            async copyOutput() {
                const output = this.clinicalOutput.value;
                if (!output) return;

                try {
                    await navigator.clipboard.writeText(output);
                    const originalText = this.copyBtn.innerHTML;
                    this.copyBtn.innerHTML = `
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Copied!
                    `;
                    this.updateStatus('success', 'Output copied to clipboard');

                    setTimeout(() => {
                        this.copyBtn.innerHTML = originalText;
                    }, 2000);
                } catch (error) {
                    console.error('Copy failed:', error);
                    this.updateStatus('error', 'Failed to copy to clipboard');
                }
            }

            clearAll() {
                if (confirm('Clear all fields? This cannot be undone.')) {
                    this.scribeInput.value = '';
                    this.clinicalOutput.value = '';
                    this.caseSelector.value = '';
                    this.promptSelector.value = '';
                    this.inputTimestamp.textContent = '--';
                    this.outputTimestamp.textContent = '--';
                    this.copyBtn.disabled = true;
                    this.updateStatus('info', 'Select a prompt and enter scribe output to begin');
                    this.updateTransformButton();
                }
            }
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================

        document.addEventListener('DOMContentLoaded', () => {
            window.emrDemo = new EMRDemo();
        });
    </script>
</body>
</html>
