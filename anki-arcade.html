<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Arcade - Retro Flashcard Game</title>
    <!-- External Libraries for .apkg Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            overflow: hidden;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Arcade Cabinet Styling */
        .arcade-cabinet {
            background: linear-gradient(to bottom, #1a0033 0%, #000 100%);
            border: 4px solid #ff00ff;
            border-radius: 20px;
            box-shadow:
                0 0 20px #ff00ff,
                inset 0 0 20px rgba(255, 0, 255, 0.2);
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen-bezel {
            background: #222;
            border: 8px solid #444;
            border-radius: 10px;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.8);
        }

        /* Title Screen */
        .title-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .title {
            font-size: 64px;
            color: #ff00ff;
            text-shadow:
                0 0 10px #ff00ff,
                0 0 20px #ff00ff,
                4px 4px 0 #00ffff;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .subtitle {
            font-size: 24px;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
            margin-bottom: 40px;
        }

        /* Upload Area */
        .upload-area {
            background: rgba(0, 255, 255, 0.1);
            border: 3px dashed #00ffff;
            border-radius: 10px;
            padding: 40px;
            margin: 20px auto;
            max-width: 600px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .upload-area.dragover {
            background: rgba(255, 0, 255, 0.2);
            border-color: #ff00ff;
        }

        .upload-text {
            font-size: 20px;
            color: #0f0;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #888;
        }

        /* Status Bar */
        .status-bar {
            background: #111;
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #888;
            font-size: 14px;
        }

        .stat-value {
            color: #0f0;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 5px #0f0;
        }

        .progress-bar {
            flex: 1;
            min-width: 200px;
            height: 20px;
            background: #222;
            border: 2px solid #0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0f0, #0ff);
            width: 0%;
            transition: width 0.5s;
            box-shadow: 0 0 10px #0f0;
        }

        /* Game Screen */
        .game-screen {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .game-screen.active {
            display: flex;
        }

        .animation-container {
            background: #000;
            border: 3px solid #ff00ff;
            border-radius: 10px;
            height: 300px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }

        /* Card Display */
        .card-container {
            background: #111;
            border: 3px solid #00ffff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .card-side-label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #888;
            font-size: 12px;
        }

        .card-content {
            font-size: 24px;
            color: #fff;
            text-align: center;
            line-height: 1.6;
        }

        /* Buttons */
        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(to bottom, #00ffff, #0088ff);
            border: 3px solid #fff;
            border-radius: 8px;
            color: #000;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            padding: 15px 30px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            box-shadow:
                0 4px 0 #006666,
                0 0 10px rgba(0, 255, 255, 0.5);
            position: relative;
            top: 0;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow:
                0 4px 0 #006666,
                0 0 20px rgba(0, 255, 255, 0.8);
        }

        .btn:active {
            top: 2px;
            box-shadow:
                0 2px 0 #006666,
                0 0 10px rgba(0, 255, 255, 0.5);
        }

        .btn-again {
            background: linear-gradient(to bottom, #ff0066, #cc0044);
            box-shadow:
                0 4px 0 #660022,
                0 0 10px rgba(255, 0, 102, 0.5);
        }

        .btn-hard {
            background: linear-gradient(to bottom, #ffaa00, #ff8800);
            box-shadow:
                0 4px 0 #884400,
                0 0 10px rgba(255, 170, 0, 0.5);
        }

        .btn-good {
            background: linear-gradient(to bottom, #00ff00, #00cc00);
            box-shadow:
                0 4px 0 #006600,
                0 0 10px rgba(0, 255, 0, 0.5);
        }

        .btn-easy {
            background: linear-gradient(to bottom, #00ffff, #00ccff);
            box-shadow:
                0 4px 0 #006699,
                0 0 10px rgba(0, 255, 255, 0.5);
        }

        .btn-show {
            background: linear-gradient(to bottom, #ff00ff, #cc00cc);
            box-shadow:
                0 4px 0 #660066,
                0 0 10px rgba(255, 0, 255, 0.5);
            font-size: 20px;
            padding: 20px 50px;
        }

        .btn-secondary {
            background: linear-gradient(to bottom, #666, #444);
            box-shadow:
                0 4px 0 #222,
                0 0 10px rgba(255, 255, 255, 0.3);
        }

        /* Summary Screen */
        .summary-screen {
            text-align: center;
            padding: 40px;
        }

        .summary-title {
            font-size: 48px;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .summary-stat {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
        }

        .summary-stat-value {
            font-size: 36px;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            margin-bottom: 5px;
        }

        .summary-stat-label {
            font-size: 14px;
            color: #888;
        }

        /* Pixel Art Animations */
        .pixel-scene {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pixel {
            position: absolute;
            image-rendering: pixelated;
        }

        /* Helper Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .keyboard-hint {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            border-radius: 5px;
            color: #ff6666;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        /* Loading Animation */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .loading {
            animation: blink 1s infinite;
        }

        /* Scanline Effect */
        .screen-bezel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 0, 0.03) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0, 255, 0, 0.03) 3px
            );
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="arcade-cabinet">
            <div class="screen-bezel">
                <!-- Upload Screen -->
                <div id="uploadScreen" class="title-screen">
                    <h1 class="title">ANKI ARCADE</h1>
                    <p class="subtitle">Retro Flashcard Adventure</p>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-text">⬆️ CLICK TO UPLOAD DECK ⬆️</div>
                        <div class="upload-hint">Drop APKG, CSV, or TSV file here</div>
                        <div class="upload-hint">(Max 300 cards • Anki export or Front/Back format)</div>
                        <input type="file" id="fileInput" accept=".apkg,.csv,.tsv,.txt" style="display: none;">
                    </div>

                    <div class="button-container mt-20">
                        <button class="btn btn-secondary" id="loadSessionBtn">LOAD SESSION</button>
                        <input type="file" id="sessionInput" accept=".json" style="display: none;">
                    </div>

                    <div id="errorMessage" class="error-message hidden"></div>

                    <div class="keyboard-hint">
                        KEYBOARD SHORTCUTS: [SPACE] Show Answer • [1] Again • [2] Hard • [3] Good • [4] Easy
                    </div>
                </div>

                <!-- Game Screen -->
                <div id="gameScreen" class="game-screen">
                    <div class="status-bar">
                        <div class="stat">
                            <span class="stat-label">CARDS:</span>
                            <span class="stat-value" id="cardsRemaining">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">REVIEWED:</span>
                            <span class="stat-value" id="cardsReviewed">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="stat">
                            <span class="stat-label">STREAK:</span>
                            <span class="stat-value" id="streak">0</span>
                        </div>
                    </div>

                    <div class="animation-container" id="animationContainer">
                        <div class="pixel-scene" id="pixelScene"></div>
                    </div>

                    <div class="card-container">
                        <div class="card-side-label" id="cardSideLabel">FRONT</div>
                        <div class="card-content" id="cardContent"></div>
                    </div>

                    <div class="button-container" id="buttonContainer">
                        <button class="btn btn-show" id="showAnswerBtn">SHOW ANSWER</button>
                    </div>

                    <div class="button-container mt-20">
                        <button class="btn btn-secondary" id="saveSessionBtn">SAVE SESSION</button>
                        <button class="btn btn-secondary" id="endSessionBtn">END SESSION</button>
                    </div>
                </div>

                <!-- Summary Screen -->
                <div id="summaryScreen" class="summary-screen hidden">
                    <h2 class="summary-title">GAME OVER</h2>
                    <p class="subtitle">Session Complete!</p>

                    <div class="summary-stats" id="summaryStats"></div>

                    <div class="button-container mt-20">
                        <button class="btn" id="newSessionBtn">NEW SESSION</button>
                        <button class="btn btn-secondary" id="downloadStatsBtn">DOWNLOAD STATS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ANKI ARCADE - Main Application
        // ============================================

        class AnkiArcade {
            constructor() {
                this.state = {
                    deck: [],
                    currentCard: null,
                    showingAnswer: false,
                    reviewedCards: 0,
                    totalReviews: 0,
                    streak: 0,
                    maxStreak: 0,
                    ratings: {
                        again: 0,
                        hard: 0,
                        good: 0,
                        easy: 0
                    },
                    startTime: null,
                    currentAnimation: null
                };

                this.animations = new ArcadeAnimations();
                this.scheduler = new SM2Scheduler();

                this.initializeUI();
                this.attachEventListeners();
            }

            initializeUI() {
                this.screens = {
                    upload: document.getElementById('uploadScreen'),
                    game: document.getElementById('gameScreen'),
                    summary: document.getElementById('summaryScreen')
                };

                this.elements = {
                    cardContent: document.getElementById('cardContent'),
                    cardSideLabel: document.getElementById('cardSideLabel'),
                    cardsRemaining: document.getElementById('cardsRemaining'),
                    cardsReviewed: document.getElementById('cardsReviewed'),
                    streak: document.getElementById('streak'),
                    progressFill: document.getElementById('progressFill'),
                    buttonContainer: document.getElementById('buttonContainer'),
                    animationContainer: document.getElementById('animationContainer'),
                    pixelScene: document.getElementById('pixelScene'),
                    errorMessage: document.getElementById('errorMessage')
                };
            }

            attachEventListeners() {
                // File upload
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e.target.files[0]));

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files[0]);
                });

                // Session management
                document.getElementById('loadSessionBtn').addEventListener('click', () => {
                    document.getElementById('sessionInput').click();
                });

                document.getElementById('sessionInput').addEventListener('change', (e) => {
                    this.loadSession(e.target.files[0]);
                });

                document.getElementById('saveSessionBtn').addEventListener('click', () => this.saveSession());
                document.getElementById('endSessionBtn').addEventListener('click', () => this.endSession());
                document.getElementById('newSessionBtn').addEventListener('click', () => this.resetToUpload());
                document.getElementById('downloadStatsBtn').addEventListener('click', () => this.downloadStats());

                // Review buttons
                document.getElementById('showAnswerBtn').addEventListener('click', () => this.showAnswer());

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeypress(e));
            }

            handleKeypress(e) {
                if (this.screens.game.classList.contains('active')) {
                    if (e.code === 'Space' && !this.state.showingAnswer) {
                        e.preventDefault();
                        this.showAnswer();
                    } else if (this.state.showingAnswer) {
                        const key = e.key;
                        if (key === '1') this.rateCard(1);
                        else if (key === '2') this.rateCard(2);
                        else if (key === '3') this.rateCard(3);
                        else if (key === '4') this.rateCard(4);
                    }
                }
            }

            async handleFileUpload(file) {
                if (!file) return;

                this.hideError();

                try {
                    let cards;

                    // Detect file type
                    if (file.name.endsWith('.apkg')) {
                        // Show loading message
                        this.showError('Loading .apkg file... <span class="loading">⏳</span>');

                        const parser = new ApkgParser();
                        cards = await parser.parse(file);
                    } else {
                        // CSV/TSV parsing
                        const text = await file.text();
                        const parser = new DeckParser();
                        cards = parser.parse(text);
                    }

                    this.hideError();

                    if (cards.length === 0) {
                        throw new Error('No valid cards found. Please ensure your file has "front" and "back" columns.');
                    }

                    if (cards.length > 300) {
                        this.showError(`Deck too large (${cards.length} cards). Limiting to first 300 cards.`);
                        cards.splice(300);
                    }

                    this.initializeDeck(cards);
                    this.startSession();

                } catch (error) {
                    this.showError(error.message);
                }
            }

            initializeDeck(cards) {
                this.state.deck = cards.map((card, index) => ({
                    id: index,
                    front: card.front,
                    back: card.back,
                    ...this.scheduler.newCard()
                }));

                this.state.reviewedCards = 0;
                this.state.totalReviews = 0;
                this.state.streak = 0;
                this.state.maxStreak = 0;
                this.state.ratings = { again: 0, hard: 0, good: 0, easy: 0 };
                this.state.startTime = Date.now();
            }

            startSession() {
                this.switchScreen('game');
                this.nextCard();
            }

            nextCard() {
                const dueCards = this.scheduler.getDueCards(this.state.deck);

                if (dueCards.length === 0) {
                    this.endSession();
                    return;
                }

                this.state.currentCard = dueCards[0];
                this.state.showingAnswer = false;

                this.updateUI();
                this.displayCard();
                this.animations.playIdle(this.elements.pixelScene);
            }

            displayCard() {
                this.elements.cardContent.textContent = this.state.currentCard.front;
                this.elements.cardSideLabel.textContent = 'FRONT';

                this.elements.buttonContainer.innerHTML = `
                    <button class="btn btn-show" id="showAnswerBtn">SHOW ANSWER [SPACE]</button>
                `;

                document.getElementById('showAnswerBtn').addEventListener('click', () => this.showAnswer());
            }

            showAnswer() {
                if (this.state.showingAnswer) return;

                this.state.showingAnswer = true;
                this.elements.cardContent.textContent = this.state.currentCard.back;
                this.elements.cardSideLabel.textContent = 'BACK';

                this.elements.buttonContainer.innerHTML = `
                    <button class="btn btn-again" onclick="app.rateCard(1)">AGAIN [1]</button>
                    <button class="btn btn-hard" onclick="app.rateCard(2)">HARD [2]</button>
                    <button class="btn btn-good" onclick="app.rateCard(3)">GOOD [3]</button>
                    <button class="btn btn-easy" onclick="app.rateCard(4)">EASY [4]</button>
                `;
            }

            rateCard(rating) {
                if (!this.state.showingAnswer) return;

                // Update scheduler
                this.scheduler.review(this.state.currentCard, rating);

                // Update statistics
                const ratingNames = ['again', 'hard', 'good', 'easy'];
                this.state.ratings[ratingNames[rating - 1]]++;
                this.state.totalReviews++;

                // Track if this is first time reviewing this card
                if (this.state.currentCard.reviews === 1) {
                    this.state.reviewedCards++;
                }

                // Update streak
                if (rating >= 3) {
                    this.state.streak++;
                    this.state.maxStreak = Math.max(this.state.maxStreak, this.state.streak);
                } else {
                    this.state.streak = 0;
                }

                // Play animation
                const success = rating >= 3;
                this.animations.playAnimation(this.elements.pixelScene, success, () => {
                    this.nextCard();
                });

                this.updateUI();
            }

            updateUI() {
                const dueCards = this.scheduler.getDueCards(this.state.deck);
                this.elements.cardsRemaining.textContent = dueCards.length;
                this.elements.cardsReviewed.textContent = this.state.reviewedCards;
                this.elements.streak.textContent = this.state.streak;

                const progress = (this.state.reviewedCards / this.state.deck.length) * 100;
                this.elements.progressFill.style.width = `${progress}%`;
            }

            endSession() {
                const duration = Math.floor((Date.now() - this.state.startTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;

                const stats = {
                    totalCards: this.state.deck.length,
                    reviewedCards: this.state.reviewedCards,
                    totalReviews: this.state.totalReviews,
                    duration: `${minutes}m ${seconds}s`,
                    maxStreak: this.state.maxStreak,
                    ratings: this.state.ratings,
                    accuracy: this.state.totalReviews > 0
                        ? Math.round(((this.state.ratings.good + this.state.ratings.easy) / this.state.totalReviews) * 100)
                        : 0
                };

                this.displaySummary(stats);
                this.switchScreen('summary');
            }

            displaySummary(stats) {
                const summaryStats = document.getElementById('summaryStats');
                summaryStats.innerHTML = `
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.reviewedCards}/${stats.totalCards}</div>
                        <div class="summary-stat-label">Cards Learned</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.totalReviews}</div>
                        <div class="summary-stat-label">Total Reviews</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.accuracy}%</div>
                        <div class="summary-stat-label">Accuracy</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.maxStreak}</div>
                        <div class="summary-stat-label">Max Streak</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.duration}</div>
                        <div class="summary-stat-label">Time Spent</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${stats.ratings.again + stats.ratings.hard}</div>
                        <div class="summary-stat-label">Needs Review</div>
                    </div>
                `;

                this.state.lastStats = stats;
            }

            saveSession() {
                const sessionData = {
                    version: 1,
                    timestamp: Date.now(),
                    state: this.state
                };

                const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `anki-arcade-session-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            async loadSession(file) {
                if (!file) return;

                try {
                    const text = await file.text();
                    const sessionData = JSON.parse(text);

                    if (sessionData.version !== 1) {
                        throw new Error('Invalid session file version');
                    }

                    this.state = sessionData.state;
                    this.startSession();

                } catch (error) {
                    this.showError('Failed to load session: ' + error.message);
                }
            }

            downloadStats() {
                if (!this.state.lastStats) return;

                const data = {
                    session: this.state.lastStats,
                    timestamp: Date.now(),
                    deck: this.state.deck.map(card => ({
                        front: card.front,
                        back: card.back,
                        interval: card.interval,
                        ease: card.ease,
                        reviews: card.reviews
                    }))
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `anki-arcade-stats-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            switchScreen(screenName) {
                Object.values(this.screens).forEach(screen => {
                    screen.classList.remove('active');
                    screen.classList.add('hidden');
                });

                this.screens[screenName].classList.remove('hidden');
                this.screens[screenName].classList.add('active');
            }

            resetToUpload() {
                this.state.currentCard = null;
                this.switchScreen('upload');
            }

            showError(message) {
                this.elements.errorMessage.innerHTML = '⚠️ ' + message;
                this.elements.errorMessage.classList.remove('hidden');
            }

            hideError() {
                this.elements.errorMessage.classList.add('hidden');
            }
        }

        // ============================================
        // APKG Parser (Anki Package Format)
        // ============================================

        class ApkgParser {
            async parse(file) {
                try {
                    // Load the .apkg file (it's a ZIP archive)
                    const arrayBuffer = await file.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);

                    // Extract the SQLite database
                    const dbFile = zip.file('collection.anki2');
                    if (!dbFile) {
                        throw new Error('Invalid .apkg file: collection.anki2 not found');
                    }

                    const dbBuffer = await dbFile.async('uint8array');

                    // Initialize sql.js
                    const SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });

                    const db = new SQL.Database(dbBuffer);

                    // Extract cards from the database
                    const cards = this.extractCards(db);

                    db.close();

                    return cards;

                } catch (error) {
                    console.error('APKG parsing error:', error);
                    throw new Error('Failed to parse .apkg file: ' + error.message);
                }
            }

            extractCards(db) {
                const cards = [];

                try {
                    // Get models (card templates) from the col table
                    const colStmt = db.prepare('SELECT models FROM col');
                    colStmt.step();
                    const colRow = colStmt.getAsObject();
                    colStmt.free();

                    const models = JSON.parse(colRow.models);

                    // Get all notes
                    const notesStmt = db.prepare('SELECT id, mid, flds FROM notes');

                    while (notesStmt.step()) {
                        const note = notesStmt.getAsObject();
                        const modelId = note.mid.toString();
                        const model = models[modelId];

                        if (!model) continue;

                        // Split fields (separated by \x1f character)
                        const fields = note.flds.split('\x1f');

                        // Get field names from model
                        const fieldNames = model.flds.map(f => f.name.toLowerCase());

                        // Try to find front/back fields
                        let frontIdx = fieldNames.findIndex(name =>
                            name === 'front' || name === 'question' || name === 'text'
                        );
                        let backIdx = fieldNames.findIndex(name =>
                            name === 'back' || name === 'answer' || name === 'extra'
                        );

                        // If not found, use first two fields
                        if (frontIdx === -1) frontIdx = 0;
                        if (backIdx === -1) backIdx = Math.min(1, fields.length - 1);

                        const front = this.stripHtml(fields[frontIdx] || '').trim();
                        const back = this.stripHtml(fields[backIdx] || '').trim();

                        if (front && back) {
                            cards.push({ front, back });
                        }
                    }

                    notesStmt.free();

                } catch (error) {
                    console.error('Error extracting cards from database:', error);
                    throw new Error('Failed to extract cards from database');
                }

                return cards;
            }

            stripHtml(html) {
                // Remove HTML tags and decode entities
                const tmp = document.createElement('div');
                tmp.innerHTML = html;

                // Remove sound tags [sound:...]
                let text = tmp.textContent || tmp.innerText || '';
                text = text.replace(/\[sound:.*?\]/g, '');

                // Remove image tags
                text = text.replace(/<img[^>]*>/gi, '');

                // Clean up extra whitespace
                text = text.replace(/\s+/g, ' ').trim();

                return text;
            }
        }

        // ============================================
        // CSV/TSV Parser
        // ============================================

        class DeckParser {
            parse(text) {
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    throw new Error('File is empty');
                }

                // Detect delimiter
                const delimiter = this.detectDelimiter(lines[0]);

                // Parse header
                const headers = this.parseLine(lines[0], delimiter).map(h => h.toLowerCase().trim());
                const frontIndex = headers.findIndex(h => h.includes('front') || h === 'question' || h === 'q');
                const backIndex = headers.findIndex(h => h.includes('back') || h === 'answer' || h === 'a');

                if (frontIndex === -1 || backIndex === -1) {
                    throw new Error('Could not find "front" and "back" columns. Headers found: ' + headers.join(', '));
                }

                // Parse cards
                const cards = [];
                for (let i = 1; i < lines.length; i++) {
                    const fields = this.parseLine(lines[i], delimiter);
                    if (fields.length > frontIndex && fields.length > backIndex) {
                        const front = fields[frontIndex].trim();
                        const back = fields[backIndex].trim();
                        if (front && back) {
                            cards.push({ front, back });
                        }
                    }
                }

                return cards;
            }

            detectDelimiter(line) {
                const commas = (line.match(/,/g) || []).length;
                const tabs = (line.match(/\t/g) || []).length;
                return tabs > commas ? '\t' : ',';
            }

            parseLine(line, delimiter) {
                const fields = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === delimiter && !inQuotes) {
                        fields.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                fields.push(current);
                return fields.map(f => f.trim());
            }
        }

        // ============================================
        // SM-2 Scheduler (Simplified)
        // ============================================

        class SM2Scheduler {
            newCard() {
                return {
                    interval: 0,
                    ease: 2.5,
                    reviews: 0,
                    lastReview: null,
                    due: Date.now()
                };
            }

            review(card, rating) {
                card.reviews++;
                card.lastReview = Date.now();

                // Rating: 1 = Again, 2 = Hard, 3 = Good, 4 = Easy
                if (rating === 1) {
                    // Again - restart
                    card.interval = 0;
                    card.ease = Math.max(1.3, card.ease - 0.2);
                } else if (rating === 2) {
                    // Hard
                    card.interval = Math.max(1, card.interval * 1.2);
                    card.ease = Math.max(1.3, card.ease - 0.15);
                } else if (rating === 3) {
                    // Good
                    if (card.reviews === 1) {
                        card.interval = 1;
                    } else if (card.reviews === 2) {
                        card.interval = 6;
                    } else {
                        card.interval = Math.round(card.interval * card.ease);
                    }
                } else if (rating === 4) {
                    // Easy
                    if (card.reviews === 1) {
                        card.interval = 4;
                    } else {
                        card.interval = Math.round(card.interval * card.ease * 1.3);
                    }
                    card.ease += 0.15;
                }

                // Set next due date (in minutes for demo purposes, would be days in real Anki)
                card.due = Date.now() + (card.interval * 60 * 1000);
            }

            getDueCards(deck) {
                const now = Date.now();
                return deck
                    .filter(card => card.due <= now)
                    .sort((a, b) => a.due - b.due);
            }
        }

        // ============================================
        // Arcade Animations
        // ============================================

        class ArcadeAnimations {
            constructor() {
                this.failAnimations = [
                    this.spaceShipFail,
                    this.pacmanFail,
                    this.platformFail,
                    this.breakoutFail,
                    this.asteroidFail
                ];

                this.successAnimations = [
                    this.spaceShipSuccess,
                    this.pacmanSuccess,
                    this.platformSuccess,
                    this.breakoutSuccess,
                    this.asteroidSuccess
                ];

                this.currentAnimationIndex = 0;
            }

            playIdle(container) {
                container.innerHTML = '<div style="color: #0f0; text-align: center; font-size: 24px; padding: 130px 20px;">READY</div>';
            }

            playAnimation(container, success, callback) {
                const animations = success ? this.successAnimations : this.failAnimations;
                const animation = animations[this.currentAnimationIndex];

                // Rotate through animations
                if (!success) {
                    this.currentAnimationIndex = (this.currentAnimationIndex + 1) % this.failAnimations.length;
                }

                animation.call(this, container, callback);
            }

            // Animation 1: Space Ship
            spaceShipFail(container, callback) {
                container.innerHTML = `
                    <div class="pixel" style="left: 50%; top: 30%; transform: translateX(-50%);">
                        <div style="position: relative; width: 60px; height: 60px;">
                            <div style="position: absolute; width: 20px; height: 40px; background: #0ff; left: 20px; top: 10px;"></div>
                            <div style="position: absolute; width: 60px; height: 20px; background: #0ff; top: 20px;"></div>
                            <div style="position: absolute; width: 10px; height: 10px; background: #f00; left: 25px; top: 25px;"></div>
                        </div>
                    </div>
                    <div class="pixel" style="left: 50%; top: 10%; transform: translateX(-50%);">
                        <div style="width: 30px; height: 30px; background: #f00; animation: fall 1s ease-in forwards;"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fall {
                        to { transform: translateY(200px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);

                setTimeout(() => {
                    // Explosion
                    container.innerHTML = `
                        <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                            <div style="width: 100px; height: 100px; position: relative;">
                                <div style="position: absolute; width: 20px; height: 20px; background: #ff0; top: 40px; left: 0; animation: explode1 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 20px; height: 20px; background: #f80; top: 0; left: 40px; animation: explode2 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 20px; height: 20px; background: #f00; top: 40px; left: 80px; animation: explode3 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 20px; height: 20px; background: #ff0; top: 80px; left: 40px; animation: explode4 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 40px; height: 40px; background: #fff; top: 30px; left: 30px; animation: flash 0.3s;"></div>
                            </div>
                        </div>
                    `;

                    const explodeStyle = document.createElement('style');
                    explodeStyle.textContent = `
                        @keyframes explode1 { to { transform: translate(-30px, -30px); opacity: 0; } }
                        @keyframes explode2 { to { transform: translate(0, -50px); opacity: 0; } }
                        @keyframes explode3 { to { transform: translate(30px, -30px); opacity: 0; } }
                        @keyframes explode4 { to { transform: translate(0, 30px); opacity: 0; } }
                        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
                    `;
                    document.head.appendChild(explodeStyle);

                    setTimeout(callback, 800);
                }, 1000);
            }

            spaceShipSuccess(container, callback) {
                container.innerHTML = `
                    <div class="pixel" style="left: 50%; bottom: 30%; transform: translateX(-50%); animation: shoot 1s ease-out;">
                        <div style="position: relative; width: 60px; height: 60px;">
                            <div style="position: absolute; width: 20px; height: 40px; background: #0ff; left: 20px; top: 10px;"></div>
                            <div style="position: absolute; width: 60px; height: 20px; background: #0ff; top: 20px;"></div>
                            <div style="position: absolute; width: 10px; height: 10px; background: #0f0; left: 25px; top: 25px;"></div>
                        </div>
                    </div>
                    <div class="pixel" style="left: 50%; top: 20%; transform: translateX(-50%);">
                        <div style="width: 40px; height: 40px; background: #f00; animation: explodeEnemy 0.8s ease-out;"></div>
                    </div>
                    <div class="pixel" style="left: 50%; bottom: 20%; transform: translateX(-50%); animation: laser 0.3s linear;">
                        <div style="width: 4px; height: 100px; background: #0f0; box-shadow: 0 0 10px #0f0;"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shoot { 0% { bottom: 30%; } 50% { bottom: 35%; } 100% { bottom: 30%; } }
                    @keyframes laser { from { opacity: 1; height: 100px; } to { opacity: 0; height: 200px; } }
                    @keyframes explodeEnemy { to { transform: scale(3); opacity: 0; background: #ff0; } }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 1200);
            }

            // Animation 2: Pac-Man
            pacmanFail(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; top: 50%; transform: translateY(-50%); animation: moveRight 2s linear;">
                        <div style="width: 50px; height: 50px; background: #ff0; border-radius: 50%; position: relative; clip-path: polygon(100% 50%, 0 0, 0 100%);"></div>
                    </div>
                    <div style="position: absolute; left: 60%; top: 50%; transform: translateY(-50%);">
                        <div style="width: 50px; height: 50px; background: #f0f; border-radius: 50%; position: relative;">
                            <div style="position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; top: 15px; left: 12px;"></div>
                            <div style="position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; top: 15px; right: 12px;"></div>
                        </div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes moveRight { to { left: 55%; } }
                `;
                document.head.appendChild(style);

                setTimeout(() => {
                    container.innerHTML = `
                        <div style="position: absolute; left: 55%; top: 50%; transform: translateY(-50%); color: #f00; font-size: 48px; animation: fadeOut 0.5s;">
                            ☠️
                        </div>
                    `;

                    const fadeStyle = document.createElement('style');
                    fadeStyle.textContent = `@keyframes fadeOut { to { opacity: 0; transform: translateY(-50%) scale(2); } }`;
                    document.head.appendChild(fadeStyle);

                    setTimeout(callback, 800);
                }, 2000);
            }

            pacmanSuccess(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; top: 50%; transform: translateY(-50%); animation: moveRight2 1.5s linear;">
                        <div style="width: 50px; height: 50px; background: #ff0; border-radius: 50%; position: relative; clip-path: polygon(100% 50%, 0 0, 0 100%);"></div>
                    </div>
                    <div style="position: absolute; left: 45%; top: 50%; transform: translateY(-50%);">
                        <div style="width: 20px; height: 20px; background: #fff; border-radius: 50%;"></div>
                    </div>
                    <div style="position: absolute; left: 65%; top: 50%; transform: translateY(-50%); animation: scared 1.5s linear;">
                        <div style="width: 50px; height: 50px; background: #00f; border-radius: 50%;"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes moveRight2 { to { left: 50%; } }
                    @keyframes scared { to { left: 80%; opacity: 0.3; } }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 1500);
            }

            // Animation 3: Platform Jump
            platformFail(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; bottom: 30%; width: 150px; height: 20px; background: #8b4513;"></div>
                    <div style="position: absolute; right: 20%; bottom: 30%; width: 150px; height: 20px; background: #8b4513;"></div>
                    <div style="position: absolute; left: 30%; bottom: 50%; animation: jumpFail 1.5s ease-in;">
                        <div style="width: 40px; height: 60px; background: #f00; position: relative;">
                            <div style="position: absolute; width: 50px; height: 10px; background: #f00; top: 20px; left: -5px;"></div>
                            <div style="position: absolute; width: 15px; height: 30px; background: #00f; left: 0; bottom: 0;"></div>
                            <div style="position: absolute; width: 15px; height: 30px; background: #00f; right: 0; bottom: 0;"></div>
                        </div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes jumpFail {
                        0% { left: 30%; bottom: 50%; }
                        50% { left: 45%; bottom: 70%; }
                        100% { left: 50%; bottom: -20%; }
                    }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 1500);
            }

            platformSuccess(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; bottom: 30%; width: 150px; height: 20px; background: #8b4513;"></div>
                    <div style="position: absolute; right: 20%; bottom: 30%; width: 150px; height: 20px; background: #8b4513;"></div>
                    <div style="position: absolute; left: 30%; bottom: 50%; animation: jumpSuccess 1.5s ease-in-out;">
                        <div style="width: 40px; height: 60px; background: #f00; position: relative;">
                            <div style="position: absolute; width: 50px; height: 10px; background: #f00; top: 20px; left: -5px;"></div>
                            <div style="position: absolute; width: 15px; height: 30px; background: #00f; left: 0; bottom: 0;"></div>
                            <div style="position: absolute; width: 15px; height: 30px; background: #00f; right: 0; bottom: 0;"></div>
                        </div>
                    </div>
                    <div style="position: absolute; left: 50%; top: 45%; color: #ff0; font-size: 36px; opacity: 0; animation: starCollect 0.5s 0.8s forwards;">⭐</div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes jumpSuccess {
                        0% { left: 30%; bottom: 50%; }
                        50% { left: 50%; bottom: 80%; }
                        100% { right: 30%; bottom: 50%; }
                    }
                    @keyframes starCollect { to { opacity: 0; transform: translateY(-50px) scale(1.5); } }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 1500);
            }

            // Animation 4: Breakout
            breakoutFail(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 50%; bottom: 10%; transform: translateX(-50%); width: 120px; height: 20px; background: #0ff; animation: paddleMiss 1s ease-in-out;"></div>
                    <div style="position: absolute; left: 50%; top: 30%; transform: translateX(-50%); animation: ballFall 1.5s ease-in;">
                        <div style="width: 20px; height: 20px; background: #fff; border-radius: 50%;"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes paddleMiss {
                        0%, 100% { transform: translateX(-50%); }
                        50% { transform: translateX(-80%); }
                    }
                    @keyframes ballFall { to { top: 100%; opacity: 0; } }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 1500);
            }

            breakoutSuccess(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; top: 20%; left: 30%; width: 40px; height: 20px; background: #f00;"></div>
                    <div style="position: absolute; top: 20%; left: 50%; width: 40px; height: 20px; background: #ff0;"></div>
                    <div style="position: absolute; top: 20%; left: 70%; width: 40px; height: 20px; background: #0f0;"></div>
                    <div style="position: absolute; left: 50%; bottom: 10%; transform: translateX(-50%); width: 120px; height: 20px; background: #0ff;"></div>
                    <div style="position: absolute; left: 50%; top: 30%; transform: translateX(-50%); animation: ballBounce 1.5s ease-in-out;">
                        <div style="width: 20px; height: 20px; background: #fff; border-radius: 50%;"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes ballBounce {
                        0% { top: 30%; }
                        30% { top: 21%; }
                        50% { top: 50%; }
                        80% { top: 70%; }
                        100% { top: 50%; }
                    }
                `;
                document.head.appendChild(style);

                setTimeout(() => {
                    container.querySelector('[style*="left: 50%"][style*="top: 20%"]').style.opacity = '0';
                }, 500);

                setTimeout(callback, 1500);
            }

            // Animation 5: Asteroid Field
            asteroidFail(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; top: 20%; width: 60px; height: 60px; background: #888; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); animation: asteroidMove1 2s linear;"></div>
                    <div style="position: absolute; right: 20%; top: 40%; width: 50px; height: 50px; background: #666; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); animation: asteroidMove2 2s linear;"></div>
                    <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                        <div style="width: 40px; height: 60px; background: #0ff; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes asteroidMove1 { to { left: 48%; top: 48%; } }
                    @keyframes asteroidMove2 { to { right: 48%; top: 48%; } }
                `;
                document.head.appendChild(style);

                setTimeout(() => {
                    container.innerHTML = `
                        <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                            <div style="position: relative; width: 100px; height: 100px;">
                                <div style="position: absolute; width: 30px; height: 30px; background: #ff0; top: 0; left: 35px; animation: debris1 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 25px; height: 25px; background: #f80; top: 35px; left: 0; animation: debris2 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 25px; height: 25px; background: #f00; top: 35px; right: 0; animation: debris3 0.5s ease-out;"></div>
                                <div style="position: absolute; width: 50px; height: 50px; background: #fff; top: 25px; left: 25px; animation: flash2 0.3s;"></div>
                            </div>
                        </div>
                    `;

                    const debrisStyle = document.createElement('style');
                    debrisStyle.textContent = `
                        @keyframes debris1 { to { transform: translateY(-50px); opacity: 0; } }
                        @keyframes debris2 { to { transform: translate(-50px, 30px); opacity: 0; } }
                        @keyframes debris3 { to { transform: translate(50px, 30px); opacity: 0; } }
                        @keyframes flash2 { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
                    `;
                    document.head.appendChild(debrisStyle);

                    setTimeout(callback, 800);
                }, 1800);
            }

            asteroidSuccess(container, callback) {
                container.innerHTML = `
                    <div style="position: absolute; left: 20%; top: 20%; width: 60px; height: 60px; background: #888; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); animation: asteroidMoveAway1 2s linear;"></div>
                    <div style="position: absolute; right: 20%; top: 40%; width: 50px; height: 50px; background: #666; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); animation: asteroidMoveAway2 2s linear;"></div>
                    <div style="position: absolute; left: 50%; bottom: 20%; transform: translateX(-50%); animation: shipNavigate 2s ease-in-out;">
                        <div style="width: 40px; height: 60px; background: #0ff; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
                    </div>
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes asteroidMoveAway1 { to { left: -10%; top: -10%; } }
                    @keyframes asteroidMoveAway2 { to { right: -10%; top: -10%; } }
                    @keyframes shipNavigate {
                        0% { bottom: 20%; }
                        50% { bottom: 60%; transform: translateX(-50%) rotate(5deg); }
                        100% { bottom: 20%; transform: translateX(-50%); }
                    }
                `;
                document.head.appendChild(style);

                setTimeout(callback, 2000);
            }
        }

        // ============================================
        // Initialize Application
        // ============================================

        let app;
        window.addEventListener('DOMContentLoaded', () => {
            app = new AnkiArcade();
        });
    </script>
</body>
</html>
